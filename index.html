<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voice Bridge — Pro Prototype</title>
  <meta name="theme-color" content="#0b2545">
  <style>
    :root{--bg:#0b2545;--card:#fff;--muted:#6b7788;--accent:#1167ff;--soft:#f4f8ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#eaf2ff 0%, #ffffff 100%)}
    .wrap{max-width:980px;margin:18px auto;padding:18px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(11,37,69,0.08)}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#00b2ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
    h1{margin:0;font-size:18px;color:var(--bg)}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}
    .controls{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:14px}
    .input-area{display:flex;flex-direction:column;gap:8px}
    textarea{width:100%;min-height:120px;border-radius:10px;padding:12px;border:1px solid #e6eefc;font-size:15px;outline:none}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,input[type=text],button{padding:10px;border-radius:10px;border:1px solid #e1eeff;background:white}
    .btn{cursor:pointer}
    .btn.primary{background:var(--accent);color:white;border:0}
    .btn.ghost{background:transparent;border:1px solid #e6eefc}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .phrases{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:8px 12px;border-radius:999px;background:var(--soft);border:1px solid #e6eefc;cursor:pointer}
    .aside{margin-top:14px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eaf4ff}
    .muted{color:var(--muted);font-size:13px}
    .settings{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    label.small{font-size:12px;color:var(--muted)}
    .big-actions{display:flex;gap:10px;margin-top:10px}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    @media(min-width:720px){ .controls{grid-template-columns:2fr 1fr} .settings{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="logo">VB</div>
        <div>
          <h1>Voice Bridge</h1>
          <p class="lead">Type or paste text → AI-correct → Speak loud & clear (Malayalam-ready)</p>
        </div>
      </header>

      <div class="controls">
        <div class="input-area">
          <div class="row">
            <select id="lang" aria-label="Language selector"></select>
            <select id="voice"></select>
            <select id="rate" title="Speech rate"><option value="0.8">Slow</option><option value="1" selected>Normal</option><option value="1.2">Fast</option></select>
            <select id="pitch"><option value="0.9">Low</option><option value="1" selected>Normal</option><option value="1.1">High</option></select>
            <button id="refreshVoices" class="btn">Refresh</button>
          </div>

          <textarea id="text" placeholder="Type what you want to say...">ഞാൻ നിങ്ങളുടെ മുൻവശത്താണ് — I'm at your door.</textarea>

          <div class="toolbar">
            <button id="aiCorrect" class="btn ghost">AI Correct (Grammar & Tone)</button>
            <button id="speakBtn" class="btn primary">Speak</button>
            <button id="conversationBtn" class="btn">Conversation Mode</button>
            <button id="saveBtn" class="btn">Save Phrase</button>
            <button id="clearBtn" class="btn">Clear</button>
          </div>

          <div class="big-actions">
            <input id="openaiKey" type="text" placeholder="(optional) OpenAI API key for better AI corrections" style="flex:1" />
            <button id="useRemoteAI" class="btn">Use Remote AI</button>
          </div>

        </div>

        <aside class="aside">
          <div class="muted">Quick phrases (tap to use):</div>
          <div class="phrases" id="phrases"></div>

          <div style="margin-top:10px" class="muted">Settings</div>
          <div class="settings">
            <div>
              <label class="small">Theme</label><br>
              <select id="theme"><option value="light">Light</option><option value="dark">Dark</option></select>
            </div>
            <div>
              <label class="small">Default Language</label><br>
              <select id="defaultLang"></select>
            </div>
            <div>
              <label class="small">Conversation Mode</label><br>
              <select id="convMode"><option value="off">Off</option><option value="on">On</option></select>
            </div>
            <div>
              <label class="small">Volume (speaker)</label><br>
              <input id="volume" type="range" min="0" max="1" step="0.05" value="1" />
            </div>
          </div>

        </aside>
      </div>

      <div class="aside" style="margin-top:12px">
        <strong>Notes & How it works</strong>
        <div class="muted" style="margin-top:6px">
          • Browsers cannot inject audio directly into a cellular call. For calls use speakerphone or install a native app later.<br>
          • Conversation Mode uses your browser's speech recognition to type what the other person says (Chrome only).<br>
          • AI Correct: offline lightweight corrections available for free; you can optionally provide an OpenAI key for stronger corrections (optional & pay-as-you-go).
        </div>
      </div>

      <footer>Voice Bridge — Malayalam-first • Built for fast, clear communication</footer>
    </div>
  </div>

<script>
// --- Voice Bridge Pro JavaScript ---
const LANGS = [ ['ml-IN','Malayalam (India)'], ['en-IN','English (India)'] ];

const langSelect = document.getElementById('lang');
const defaultLang = document.getElementById('defaultLang');
const voiceSelect = document.getElementById('voice');
const textEl = document.getElementById('text');
const speakBtn = document.getElementById('speakBtn');
const saveBtn = document.getElementById('saveBtn');
const phrasesDiv = document.getElementById('phrases');
const clearBtn = document.getElementById('clearBtn');
const refreshVoicesBtn = document.getElementById('refreshVoices');
const aiCorrectBtn = document.getElementById('aiCorrect');
const rateSelect = document.getElementById('rate');
const pitchSelect = document.getElementById('pitch');
const convBtn = document.getElementById('conversationBtn');
const volumeSlider = document.getElementById('volume');
const openaiKeyInput = document.getElementById('openaiKey');
const useRemoteAI = document.getElementById('useRemoteAI');

LANGS.forEach(([code,label])=>{
  const o=document.createElement('option'); o.value=code; o.textContent=label; langSelect.appendChild(o);
  const o2=o.cloneNode(true); defaultLang.appendChild(o2);
});
langSelect.value='ml-IN'; defaultLang.value='ml-IN';

// Phrases storage & UI
function loadPhrases(){
  const data = JSON.parse(localStorage.getItem('vb_pro_phrases')||'null');
  const list = Array.isArray(data) ? data : [
    'ഞാൻ നിങ്ങളുടെ മുൻവശത്താണ് (I am at your door)',
    'ദയവായി ഗേറ്റിന് പുറത്തിറങ്ങുക (Please come to the gate)',
    'നന്ദി — Have a nice day',
    'പേയ്മെന്റ് ചെയ്യാൻ തന്നെ വരണ്ടേ?', // example Malayalam phrase
  ];
  renderPhrases(list);
}
function renderPhrases(list){
  phrasesDiv.innerHTML='';
  list.forEach((p,idx)=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=p;
    b.onclick=()=>{ textEl.value=p; speakText(p); };
    b.oncontextmenu=(e)=>{ e.preventDefault(); removePhrase(idx); };
    phrasesDiv.appendChild(b);
  });
}
function removePhrase(index){
  let arr=JSON.parse(localStorage.getItem('vb_pro_phrases')||'null'); if(!Array.isArray(arr)) arr=[];
  arr.splice(index,1); localStorage.setItem('vb_pro_phrases',JSON.stringify(arr)); loadPhrases();
}
saveBtn.onclick = ()=>{
  const t=textEl.value.trim(); if(!t) return alert('Type something first');
  let arr=JSON.parse(localStorage.getItem('vb_pro_phrases')||'null'); if(!Array.isArray(arr)) arr=[];
  arr.unshift(t); arr=arr.filter(Boolean).slice(0,50); localStorage.setItem('vb_pro_phrases',JSON.stringify(arr)); loadPhrases();
}
clearBtn.onclick = ()=>{ textEl.value=''; }

// voices
let voices=[];
function loadVoices(){
  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML='';
  const selLang = (langSelect.value || 'ml-IN').split('-')[0];
  const filtered = voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith(selLang));
  (filtered.length?filtered:voices).forEach((v,idx)=>{
    const o=document.createElement('option'); o.value=idx; o.textContent = v.name + ' ('+v.lang+')'; voiceSelect.appendChild(o);
  });
}
refreshVoicesBtn.onclick = ()=> loadVoices();
langSelect.onchange = ()=> loadVoices();
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = loadVoices; setTimeout(loadVoices,200); }

// offline AI-correction (lightweight)
function offlineAICorrect(text, lang){
  text = text.replace(/\s+/g,' ').trim();
  if(!text) return text;
  // If Latin script => basic sentence casing
  if(/^[A-Za-z]/.test(text)){
    text = text.charAt(0).toUpperCase() + text.slice(1);
    if(!/[.?!]$/.test(text)) text += '.';
  }
  // small common fixes
  text = text.replace(/\bi m\b/gi, "I'm").replace(/\bu\b/gi,'you');
  return text;
}
aiCorrectBtn.onclick = async ()=>{
  const original = textEl.value;
  if(!original.trim()) return alert('Type something first');
  const corrected = offlineAICorrect(original, langSelect.value);
  textEl.value = corrected;
  speakText(corrected);
}

// remote AI placeholder (secure server recommended)
useRemoteAI.onclick = ()=>{
  const key = openaiKeyInput.value.trim();
  if(!key) return alert('Paste your OpenAI API key (optional) to use remote AI.');
  alert('Remote AI requires a small server to keep your key secret. I can give you the server code when you want.');
}

// TTS playback
function speakText(text){
  if(!('speechSynthesis' in window)) return alert('Your browser does not support speechSynthesis. Use Chrome or Edge.');
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang = langSelect.value || 'ml-IN';
  const vIdx = parseInt(voiceSelect.value);
  if(voices && voices.length && !isNaN(vIdx)){ const v = voices[vIdx]; if(v) u.voice = v; }
  u.rate = parseFloat(rateSelect.value)||1; u.pitch = parseFloat(pitchSelect.value)||1;
  speechSynthesis.speak(u);
}
document.getElementById('speakBtn').onclick = ()=>{ const t=textEl.value.trim(); if(!t) return alert('Type something first'); speakText(t); }
textEl.addEventListener('keydown',(e)=>{ if(e.ctrlKey && e.key==='Enter'){ document.getElementById('speakBtn').click(); } });

// Conversation Mode using Web Speech Recognition
let recognizing=false; let recognition=null;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.continuous = false; recognition.interimResults=false; recognition.lang = langSelect.value;
  recognition.onresult = (ev)=>{ const t = ev.results[0][0].transcript; textEl.value = t; speakText(t); };
  recognition.onend = ()=>{ recognizing=false; convBtn.textContent='Conversation Mode'; };
}
convBtn.onclick = ()=>{
  if(!recognition) return alert('Speech Recognition not supported in this browser. Use Chrome on Android.');
  if(!recognizing){ recognition.lang = langSelect.value; recognition.start(); recognizing=true; convBtn.textContent='Listening... (tap to stop)'; }
  else{ recognition.stop(); recognizing=false; convBtn.textContent='Conversation Mode'; }
}

// Init
loadPhrases();
document.getElementById('theme').onchange = (e)=>{ if(e.target.value==='dark'){ document.body.style.background='linear-gradient(180deg,#061233,#0b2545)'; document.body.style.color='#fff'; } else { document.body.style.background='linear-gradient(180deg,#eaf2ff,#ffffff)'; document.body.style.color='#0b2545'; } }
</script>
</body>
</html>
